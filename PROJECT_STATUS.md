# Project Status ‚Äî Agency OS

_Last updated: 2025-12-03 (EST)_

## How to Use This File
- Skim **Quick Recap**, **Recent Accomplishments**, and **Next Priorities** before coding.
- Update the date and add a brief note under **Recent Accomplishments** when you finish a session.
- Keep the **Documentation Map** aligned with the contents of `docs/` so we always know where deeper specs live.
- Whenever we add or modify a service/app, update `docs/10_systems_overview.md` so the systems inventory matches reality.
- For backend work: activate the FastAPI virtual env via `source backend-core/.venv/bin/activate`; deactivate with `deactivate`. Install deps using `python3 -m venv backend-core/.venv && source backend-core/.venv/bin/activate && python3 -m pip install -r backend-core/requirements.txt`.
- Export Supabase vars before starting uvicorn (these match Render env group values):
  ```
  export SUPABASE_JWT_SECRET="******"
  export SUPABASE_URL="https://iqkmygvncovwdxagewal.supabase.co"
  export SUPABASE_SERVICE_ROLE="******"
  export ENABLE_USAGE_LOGGING=1
  uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
  ```

## Quick Recap
Agency OS consolidates internal tools (Ngram, The Operator, Creative Brief) behind a shared Next.js frontend, FastAPI backend, and Supabase auth stack deployed on Render. Supabase handles SSO (Google) plus the shared database, while the worker service manages nightly syncs and other heavy jobs. **Amazon Composer is deprecated** and will be replaced by the new **Scribe** project (simpler, more focused listing/content generation). **Scribe is currently being rebuilt ("Scribe Lite")** to simplify the UX, with legacy code archived.

## Recent Accomplishments
- **2025-12-04 (EST)**
  - **Scribe Stage C CSV Export & Dirty Regenerate ‚úÖ:** Implemented `/api/scribe/projects/[projectId]/export-copy` with dynamic attribute columns, padded bullets, backend keyword cleanup, and filename convention; wired Stage C Export button with loading/error handling. Dirty-state now forces full regenerate-all when stale.
  - **Scribe Test Coverage Expanded ‚úÖ:** Added API tests for export-copy, generate-copy, generated-content GET/PATCH, topics selection cap, and regenerate-copy; added UI tests for SkuTopicsCard. Composer test suites quarantined via `describe.skip` to keep CI lean. StageC component tests remain skipped with a note (jsdom brittle; covered by API/UI elsewhere). Full `npm run test:run` passing (except intentional skips).
- **2025-12-04 (EST)**
  - **N-Gram Two-Step Negatives Flow ‚úÖ:** Refreshed `/ngram` UI into two clear cards (generate workbook, then upload filled workbook to download negatives summary), added playful loading states, and delivered a new collector that outputs a formatted NE summary (Excel) without Excel repair dialogs. Collector now zips mono/bi/tri per campaign and ignores scratchpad to avoid duplicates.
  - **N-PAT PRD & Plan Ready ‚úÖ:** Authored `docs/03_npat_prd.md` (ASIN-only inverse of N-Gram with H10 enrichment) and `docs/03_npat_plan.md` (micro-task plan). PRD aligns with N-Gram conventions: uppercase ASIN pipe strings, 40MB cap, full metrics in negatives summary, H10 paste schema documented.
  - **Scribe Stage C Export CSV Shipped ‚úÖ:** Added `/api/scribe/projects/[projectId]/export-copy` to stream Amazon-ready CSV including SKU/Product/ASIN, custom attributes, title, bullets 1-5, description, and backend keywords (space-delimited). UI Export button now downloads with loading/error handling and filename `scribe_<project-slug>_amazon_content_<timestamp>.csv`.
  - **Scribe Stage C Dirty-State Regenerate Fix ‚úÖ:** Dirty banner now forces full regeneration instead of blocking when all SKUs already have content; Generate All toggles to ‚ÄúRegenerate All‚Äù when stale.
- **2025-12-03 (EST)**
  - **Scribe Stage C Export CSV Shipped ‚úÖ:** Added `/api/scribe/projects/[projectId]/export-copy` to stream Amazon-ready CSV including SKU/Product/ASIN, custom attributes, title, bullets 1-5, description, and backend keywords (space-delimited). UI Export button now downloads with loading/error handling and filename `scribe_<project-slug>_amazon_content_<timestamp>.csv`.
  - **Scribe Stage C Dirty-State Regenerate Fix ‚úÖ:** Dirty banner now forces full regeneration instead of blocking when all SKUs already have content; Generate All toggles to ‚ÄúRegenerate All‚Äù when stale.
- **2025-12-03 (EST)**
  - **Scribe Stage B Topic Selection Bug Fixed ‚úÖ:** Resolved critical issue where topic selections weren't persisting to database. Root cause was React state closure issue in `handleToggleTopic` - the `newSelected` variable was being calculated inside `setTopicsBySku` callback but React's batching caused the fetch to run before the callback completed, always sending `selected: false`. Fix: Read current state directly from `topicsBySku` before calling setState, calculate `newSelected` immediately, then use that value for both state update and API call. Added comprehensive console logging to debug data flow. Topic selections now persist correctly across page refreshes and Stage C can successfully validate 5 selected topics per SKU before generation.
  - **Scribe Stage C Attribute Preferences Specification Complete ‚úÖ:** Documented complete Attribute Preferences feature in Scribe Lite PRD (`docs/scribe_lite/scribe_lite_prd.md` sections 3.3.1-3.3.6). Feature allows users to control which custom attributes (Size, Color, Material, etc.) appear in specific sections (Title, Bullets, Description) of generated Amazon copy. Key design decisions: (1) Single table applies preferences to ALL SKUs project-wide (simpler than per-SKU), (2) Collapsed by default with clear example ("picture frames + dimensions"), (3) Auto-save on checkbox toggle with optimistic updates, (4) Preferences stored in `scribe_skus.attribute_preferences` jsonb field with structure `{ mode: "overrides", rules: { "Size": { sections: ["title"] } } }`. Created comprehensive implementation prompt for another AI including data flow, component structure, API calls, validation, and testing checklist. Marked legacy `AttributePreferencesCard.tsx` for deletion (per-SKU version incompatible with new design).
- **2025-12-02 (EST)**
  - **Scribe Stage B (Topics) Shipped ‚úÖ:** Built complete Stage B UI with topic generation workflow. Created 4 new components: `StageB.tsx` (main logic), `DirtyStateWarning.tsx` (reusable warning banner), `SkuTopicsCard.tsx` (topic selection per SKU), and `stage-b/page.tsx` (lean orchestrator). Implemented "Generate Topics" button with async job processing (polling endpoint at `/api/scribe/jobs/[jobId]`), enforced 5-topic selection limit per SKU, dirty state detection (compares SKU update times vs topic creation times), and Previous/Next navigation. **Topic Selection Persistence:** Added migration `20251202000001_scribe_topics_selected.sql` to add `selected` boolean column to `scribe_topics` table, created `PATCH /api/scribe/projects/{projectId}/topics/{topicId}` endpoint for saving selections with server-side 5-topic limit validation, and wired up StageB.tsx with optimistic updates and error rollback. Topic selections now persist across page refreshes and are ready for Stage C copy generation. **Topic Generator Enhancement:** Updated `topicsGenerator.ts` prompt from "Generate 1‚Äì8 distinct" to "Generate exactly 7-8 distinct" topics and added validation to ensure at least 7 topics are generated (throws error if fewer). **UI Polish:** Fixed topic description bullet formatting by adding `whitespace-pre-line` class so bullets display on separate lines. **Approval Cleanup:** Removed all approval gate logic from 5 API routes (generate-topics, generate-copy, regenerate-topics, regenerate-copy, generated-content PATCH) and deleted 6 unused approval endpoint directories (approve-stage-a, approve-topics, approve-copy, unapprove-stage-a, unapprove-topics, unapprove-copy) including 11 files total (routes + tests). Type definitions in `projects/route.ts` and `restore/route.ts` preserved for backwards compatibility with legacy project statuses.
  - **Scribe Stage A Polish ‚úÖ:** Fixed EditSkuPanel issues: (1) Save button incorrectly disabled when editing - removed keyword/question count from `canSave` condition, added validation warnings instead. (2) Custom attributes empty after reload - implemented full custom attribute save logic with attribute ID lookup and parallel API calls. (3) Keywords exceeding 10/10 limit - added delete-before-insert logic to prevent accumulation on re-save. (4) Performance optimization - replaced sequential API calls with Promise.all() for parallel operations (keywords delete+insert, questions delete+insert, custom attributes save), reducing save time from several seconds to near-instant. Also fixed custom attribute deletion bug - changed DELETE request from path parameter format to query parameter format (`/variant-attributes?id={id}`) to match API expectations.
  - **Scribe CSV Upload Bug Fixes ‚úÖ:** Fixed three critical CSV upload issues preventing reliable data import. (1) **Tab-delimited CSV support** - CSV parser now auto-detects delimiter (tab vs comma) instead of hardcoding commas, enabling TSV imports from Excel/Sheets. (2) **Field name mismatch** - Fixed keyword/question count display by changing snake_case (`sku_id`) to camelCase (`skuId`) to match API response format. (3) **Duplicate upload handling** - Added delete-before-insert logic for keywords and questions to prevent "Maximum of 10 keywords per scope" errors on re-uploads. All SKU data now properly overwrites on re-upload: core fields use PATCH, keywords/questions delete+insert, and custom attributes upsert via API.
  - **Scribe Lite Foundation Components Shipped ‚úÖ:** Built reusable `ScribeHeader` and `ScribeProgressTracker` components implementing the non-blocking wizard flow. Replaced approval/locking complexity with "Dirty State" model (stale data warnings + regenerate prompts). Updated PRD to document the new architecture: free navigation between stages, explicit completeness props, and simplified state management. Home page (`/scribe`) polished with disabled-until-name-entered Create button.
  - **Scribe Lite Restart Initiated üîÑ:** Archived legacy Scribe frontend (`_legacy_v1`) and documentation (`docs/archive/scribe_legacy`) to clear technical debt. Created **Scribe Lite** plan (`docs/scribe_lite/`) focusing on a simplified "Wizard" UX while reusing the robust backend/DB foundation. Canonical Schema & API Reference created to guide the rebuild.
  - **Scribe Stage A (Inputs) Complete ‚úÖ:** Finalized the SKU Input stage. Implemented robust CSV upload logic that auto-detects and creates custom attributes (e.g., "Size", "Material") on the fly. Fixed Edit Panel to correctly fetch and save these dynamic attributes, along with keywords and questions. Validated schema against production DB dump.
- **2025-11-29 (EST)**
  - **Scribe Stage navigation/approval guard fixes ‚úÖ:** Normalized status handling across stepper and stage components so refreshes land on the correct stage, navigation/next buttons unlock when later stages are approved, and Stage A buttons no longer show misleading locked states when downstream stages are approved.
- **2025-11-28 (EST)**
- **Scribe Stage C shipped (backend + UI) ‚úÖ:** Generate/regenerate/approve/edit routes live with gates/limits, job runner wired, Stage C fields in CSV export, Stage C UI added (empty state, per-SKU editor, regenerate, version, approval gate). Attribute prefs stored/passed; UI toggle is minimal and needs further polish. Usage logs now tag stage; `scribe_generated_content.sku_id` unique index added. RLS bug on PATCH fixed. Unapprove endpoints added for Stage B/C; UI locks editing when approved; export CTA added to Stage C (CSV includes dynamic variant attrs and Stage C fields). Stage A edits lock when later stages are approved.
- **Scribe CSV export fixes ‚úÖ:** Fixed column misalignment caused by unquoted fields containing commas (e.g., "Friendly, casual, approachable") and special characters (em dashes). Applied RFC 4180 CSV formatting with proper field quoting, quote escaping, newline stripping, and UTF-8 BOM (`\uFEFF`) for Excel compatibility. Fixed both server-side export route and client-side Download Template function.
- **Scribe variant attribute values persistence fixed ‚úÖ:** Resolved 500 error preventing variant values (Color, Size) from saving. Root cause was `onConflict` parameter incompatibility with remote Supabase constraint naming. Replaced native `upsert()` with manual check-then-update-or-insert logic to avoid constraint name issues entirely. Values now persist correctly across page refreshes and appear in CSV exports.
- **2025-11-27**
  - **Scribe Stage C spec ready (docs)** ‚úÖ: PRD, implementation plan, schema, prompt/orchestration, and test plan updated for Stage C (copy generation). Added micro-tasks, clarified gates/limits (title ~200, bullets=5, backend keywords 249 bytes), default full regenerate, attribute prefs lightweight, and approval flow. Composer tests quarantined; Scribe tests passing.
- **2025-11-27**
  - **Scribe Stage B tests passing** ‚úÖ: Added Stage B gate, job, CSV edge, RLS/limits telemetry tests (Vitest). Composer test suites quarantined (deprecated). Generate-copy/import tests in place with placeholders until Stage C routes ship.
- **2025-11-27**
  - **Scribe Stage B refinements** ‚úÖ: Updated topics prompt to 3-bullet descriptions, UI renders bullets, token usage logging wired (`scribe_usage_logs` per LLM call), status names aligned to `stage_a_approved`/`stage_b_approved`/`stage_c_approved` across frontend/API, and Stage B test plan refreshed.
- **2025-11-27**
  - **Scribe Stage A polished & CSV upsert** ‚úÖ: Rebuilt Stage A to grouped per-SKU blocks with scalar modules, inline multi-value lists, copy-from, inline attribute delete, and per-SKU approve/unapprove. CSV import now upserts by `sku_code`, patches scalars/words, replaces keywords/questions, strips bullets, and is quote-aware to avoid duplicate SKUs. Export renamed to Download Template. Frontend keeps local state (no wipe on add/delete) and hides spurious errors. PRD/implementation plan updated to match approve/unapprove and import upsert semantics.
- **2025-11-26**
  - **Scribe per-SKU migration and docs aligned** ‚úÖ: Applied Supabase migration to drop shared/default columns, rename override fields, and enforce `sku_id` NOT NULL on keywords/questions/topics (per-SKU-only model). PRD and implementation plan updated to the grouped-row Stage A UI, per-SKU-only Stage B/C, and legacy migration marked as optional. Backend Phase 2 (per-SKU APIs + copy-from-SKU endpoint/tests) completed.
- **2025-11-25**
  - **Scribe Slice 1 (Projects Shell) Complete** ‚úÖ: Added Scribe projects API (list/create/detail/update, archive/restore) with owner scoping and status transition guards. Implemented frontend dashboard at `/scribe` with create form, pagination, archive/restore, and CTA styling aligned to the homepage. Enabled auto-creation of profiles on auth user insert; seeded admin profile to clear FK issues.
  - **Scribe Stage A Grid In Progress** üöß: Refactored `/scribe/[projectId]` into a single grid-centric Stage A layout (sticky SKU column, horizontal scroll, dynamic variant attribute columns). Added shared defaults controls, inline overrides with indicators, SKU inline edit/reorder/delete, variant value grid, per-SKU keyword/question counts, and CSV import/export hooks in the grid toolbar. Pending: popover editors for keywords/questions and additional tests.
- **2025-11-22**
  - **Composer Deprecated, Scribe Announced** ‚úÖ: Paused further Composer slices (Stage 8+). Marked Composer as frozen and initiated replacement effort with Scribe (new content-generation project). Planning Supabase cleanup of Composer tables/types after Scribe ships. Existing Composer data retained; no new work will land there.
- **2025-11-22**
  - **Fixed Keyword Grouping Generation** ‚úÖ: Resolved three critical issues preventing "GENERATE GROUPING PLAN" button from working. (1) Fixed empty pools array - page.tsx now uses `useKeywordPools` hook to pass actual pool data to `GroupingPlanStep` component instead of empty array, enabling button handler to access currentPool. (2) Implemented actual AI grouping logic - replaced placeholder chunking algorithm with real `groupKeywords()` function call from `@agency/lib/composer/ai/groupKeywords`, added project context fetching (clientName, category) for better AI results, implemented comprehensive usage logging for both success and error cases via `logUsageEvent()`. (3) Fixed API response format - changed from `{ groupsCreated: number }` to `{ groups: ComposerKeywordGroup[] }` with full group objects mapped from database rows, matching expected format from tests and frontend code. Fixed TypeScript build error by adding type assertion `pool.pool_type as "body" | "titles"` to match strict type requirements. Verified OpenAI API integration correctly reads `OPENAI_API_KEY`, `OPENAI_MODEL_PRIMARY`, and `OPENAI_MODEL_FALLBACK` from Render environment variables (not hardcoded). **Render deploy succeeded.** Keyword grouping generation now fully functional end-to-end.
- **2025-11-21**
  - **Completed Database Migrations for Team Central, The Operator, and ClickUp Service** ‚úÖ: Created and deployed 3 production-ready Supabase migrations implementing foundation infrastructure for new Agency OS features. **Team Central** (`20250122000001_team_central_tables.sql`) implements single-tenant team management with `profiles` enhancements (role-based access via `team_role` enum), `team_members_pending` invitation system with auto-link trigger, `agency_clients` tracking, and `client_assignments` junction table. **The Operator** (`20250122000002_operator_tables.sql`) implements multi-tenant SOP management with pgvector embeddings (1536 dimensions for OpenAI ada-002), `sops` table with HNSW vector similarity search, and `ops_chat_sessions` for AI chat history. **ClickUp Service** (`20250122000003_clickup_service_tables.sql`) implements multi-tenant ClickUp API integration with encrypted credentials (pgcrypto), cache tables for spaces/users/tasks (TTL: 1hr/24hr/5min), and sync status tracking. All migrations use composite primary keys `(organization_id, id)` for multi-tenancy, comprehensive RLS policies with organization isolation, proper foreign key cascades, and idempotent DDL (`IF NOT EXISTS`). Fixed initial profiles table creation issue during deployment. All 3 PRDs now have matching database implementations.
  - **Completed Composer Slice 2 Stage 7 (Keyword Grouping UI)** ‚úÖ: Shipped full drag-and-drop grouping interface with tab navigation (body/titles pools), 3-state progress indicator (Configure ‚Üí Review ‚Üí Approve), `@dnd-kit` drag-and-drop for keyword assignment, approval/unapproval workflow with optimistic locking (prevents race conditions via `updated_at` timestamp check), override tracking for manual keyword moves (audit trail in `composer_keyword_group_overrides`), and timestamp consistency fixes (both `approved_at` and `grouped_at` cleared together on unapproval). Created 5 new UI components: `GroupingPlanStep`, `KeywordGroupCard`, `DraggableKeyword`, `GroupingConfigForm`, and `types.ts`. Added 1 new API endpoint: `POST /approve-grouping` with concurrent modification protection (returns 409 on conflict). Extended `useKeywordPools` hook with 6 new methods: `generateGroupingPlan`, `getGroups`, `addOverride`, `resetOverrides`, `approveGrouping`, `unapproveGrouping`. Implemented 3 critical fixes identified during Red Team review: (1) Override tracking - non-blocking audit trail, (2) Optimistic locking - race condition prevention, (3) Timestamp consistency - paired approval/grouping timestamps. All changes follow existing patterns from Stage 5 cleanup step. **Build deployed successfully to Render. Manual testing pending.** **Composer Slice 2 Stages 1-7 now complete.**
  - Fixed two Render build issues during Stage 7 deployment: (1) Updated approval endpoint to use correct imports (`createSupabaseRouteClient` from `@/lib/supabase/serverClient`), (2) Added missing `@dnd-kit/core` and `@dnd-kit/utilities` dependencies for drag-and-drop UI components.
  - Updated Stage 6 grouping backend to log actual OpenAI usage metrics (model/tokens/duration) returned by the orchestrator; added minimal Supabase typing to keep Render/Turbopack builds passing. Render deploy succeeded; full suite **235 tests** passing.
  - Added Stage 5 cleanup UI tests (KeywordCleanupStep, CleanedKeywordsList, RemovedKeywordsList, `unapproveClean`) ‚Äî cleanup step now fully covered.
- **2025-11-20**
  - Completed Composer Slice 2 Stage 6 (Keyword Grouping APIs & AI Integration): shipped AI-powered keyword grouping with OpenAI gpt-5.1-nano integration, 4 grouping basis types (single, per_sku, attribute, custom), merge utility for AI groups + user overrides (move/remove/add), 4 production APIs (grouping-plan, groups GET, group-overrides POST/DELETE), comprehensive usage event logging to `composer_usage_events` table, and complete test coverage. Logging now records actual OpenAI usage (model/tokens/duration) returned by the orchestrator. Enhanced usage logging tests to explicitly verify all parameters (organizationId, projectId, tokens, duration, meta) on both success and error paths per QA agent recommendation. Full test suite: **235 passing tests** (50 new for Stage 6).
  - Completed Composer Slice 2 Stage 5 (Keyword Cleanup UI): shipped production-ready cleanup interface with tab-based navigation (Description & Bullets / Titles), 3-state progress indicator (Run ‚Üí Review ‚Üí Approve), stateful approval toggle (approve/unapprove with `unapproveClean()`), collapsible keyword lists (400px max-height scroll for 3000+ keywords), grouped removed keywords by reason with color-coded badges (7 types), manual remove/restore, confirmation checkbox, and "Continue to Titles Pool" button. Uses unicode symbols (‚ñ≤‚ñº‚ñ∂‚úì) with no icon library dependency.
  - Added Vitest coverage for Stage 5 cleanup UI and hooks (CleanedKeywordsList, RemovedKeywordsList, KeywordCleanupStep, `unapproveClean`); full `npm run test:run` passes all tests. Targeted Stage 5 command: `npm run test:run -- 'src/lib/composer/hooks/useKeywordPools.test.tsx' 'src/app/composer/[projectId]/components/keyword-cleanup/CleanedKeywordsList.test.tsx' 'src/app/composer/[projectId]/components/keyword-cleanup/RemovedKeywordsList.test.tsx' 'src/app/composer/[projectId]/components/keyword-cleanup/KeywordCleanupStep.test.tsx'`.
  - Completed Composer Slice 2 Stage 4 (Keyword Upload UI): added keyword upload step with scope-aware tabs, CSV/paste/manual inputs, dedupe/validation (min 5, warn <20), and optimistic hooks/tests. Upload works for both pools and group scopes.
  - Completed Composer Slice 2 Stage 3 (Keyword Cleanup APIs & Logic): added deterministic cleaning service (brand/competitor from project data, attribute-driven color/size filters, stopword list), synchronous clean route with RLS checks, approval gating on PATCH, and full Vitest coverage for cleaning + routes. Render build fixed and passing.
  - Fixed Composer frontend Render build by enabling monorepo imports (`externalDir` + output tracing root) so shared `lib` modules bundle correctly with Turbopack.
  - Completed Composer Slice 2 Stage 2 (Keyword Pool APIs): shipped keyword upload/merge endpoints for projects and groups (GET/POST list, GET/PATCH single), added CSV parsing + dedupe helpers, enforced state-reset rules on uploads, and expanded org-scoped tests. Utility + route coverage brought the suite to 148 passing tests (up from 82).
- **2025-11-20** ‚Äì Completed Composer Slice 2 Stage 1 (Schema & Backend Foundation): created 3 keyword pipeline tables (`composer_keyword_pools`, `composer_keyword_groups`, `composer_keyword_group_overrides`) with full RLS policies, CASCADE foreign keys, and indexes. All TypeScript types already up-to-date in `/lib/composer/types.ts`. Ready for Stage 2 API implementation.
- **2025-11-19** ‚Äì Drafted and documented Composer Slice 2 (Keyword Pipeline) implementation plan: aligned schema/types with keyword pool state machine, manual overrides, and new API surface so we can begin Slice 2 build-out. Included explicit keyword upload validation (minimum 5 terms, recommended 50+) in both PRD and implementation plan so UX clarifies expectations.
- **2025-11-19** ‚Äì Wrapped Composer Slice 1 polish: added key-attribute highlight grid, persisted `highlight_attributes` JSON (schema + types), introduced keyword grouping override spec, and documented/testing updates (82 passing Vitest suites). Ready to start Slice 2 planning.
- **2025-11-19** ‚Äì Hardened Composer Slice 1 Surface 4 with shared `serverUtils` helpers, Supabase route-client mocks, and full Vitest coverage for the groups/assign/unassign APIs plus the `useSkuGroups` hook (82 tests passing locally via `npm run test:run`).
- **2025-11-19** ‚Äì Completed Composer Slice 1 Surface 4 (Content Strategy): StrategyToggle, SkuGroupsBuilder, GroupCard, UnassignedSkuList, and ContentStrategyStep components; full SKU groups API (GET/POST groups, PATCH/DELETE group, assign/unassign variants); `useSkuGroups` hook with optimistic updates. Slice 1 is now feature-complete.
- **2025-11-18** ‚Äì Migrated the frontend to `@supabase/ssr`, fixed the async cookies regression, and aligned the Composer fallback org (`DEFAULT_COMPOSER_ORG_ID = e9368435-‚Ä¶`). Documented the rule that Supabase users must carry the same `org_id` metadata; legacy Composer rows were updated so existing projects resurface in the dashboard.
- **2025-11-17** ‚Äì Finished Composer Slice 1 Surface 3 (Product Info): full autosave meta forms, FAQ editor, SKU intake (inline edits, CSV import/merge, org-scoped APIs), CSV parser, and SKU validation/persistence so projects can resume from the wizard.
- **2025-11-16** ‚Äì Brought Composer Slice 1 Surface 1+2 online: dashboard list/create, wizard frame with autosave shell, GET/PATCH detail API, Supabase default org fallback, and new Supabase client helper (`createPagesBrowserClient`). Ready to plug Product Info & Strategy UIs into the shell.
- **2025-11-15** ‚Äì Landed Composer schema + tenancy work: created all `composer_*` tables in Supabase, enforced RLS with org-scoped policies (`docs/composer/01_schema_tenancy.md`), and published the canonical TypeScript types (`docs/composer/02_types_canonical.md` + `/lib/composer/types.ts`) so the frontend/backed/AI layers share the same model.
- **2025-11-14** ‚Äì Rebuilt the Composer PRD (v1.6) and captured the corresponding end-to-end implementation plan (`docs/06_composer_implementation_plan.md`) so future work can follow defined slices/workstreams without ambiguity.
- **2025-11-13** ‚Äì Migrated the N-Gram Processor into the new stack: FastAPI backend (`backend-core/app/routers/ngram.py` + services) with Supabase usage logging, plus a refreshed `/ngram` Next.js page and home screen shortcut. Local Supabase env + venv instructions captured in this doc for future sessions.
- **2025-11-13** ‚Äì Added Supabase-aware Next.js middleware to guard `/ngram`, ensuring logged-out users are redirected to the login screen before hitting protected pages.

## Next Priorities
- **Scribe Lite Implementation**: Build the new "Wizard" UI (Inputs -> Topics -> Output) based on the Scribe Lite PRD and upcoming UI specs.
- **Scribe Lite QA**: Verify the new flow against the canonical API reference.
- **Composer decommission plan**: Execute `docs/17_composer_deprecation_plan.md` when Scribe B/C are stable (UI flag-off, code/schema cleanup with backups).
- **N-Gram**: Monitor two-step negatives summary in prod; validate Render timeouts and file-size handling on large STRs.
- **N-PAT**: Start implementation per `docs/03_npat_plan.md` (router, parser, workbook, frontend two-step).

## Documentation Map (Quick Reference)
- `docs/00_agency_os_architecture.md` ‚Äî High-level blueprint for the Render services, Supabase auth setup, and domain migration strategy. Start here for infra questions or when onboarding collaborators.
- `docs/01_ngram_migration.md` ‚Äî Detailed checklist for splitting the legacy Ngram processor into the new frontend/backed pattern (dependencies, routers, CORS). Use when working on `/ngram`.
- `docs/02_the_operator_prd.md` ‚Äî Product + technical spec for The Operator AI assistant (M1). Covers UX flows, agent responsibilities, SOP management with AI embeddings, and multi-tenant data model. Database migration: `20250122000002_operator_tables.sql`.
- `docs/04_amazon_composer_prd.md` ‚Äî Amazon listing generation workflow (input wizard, AI draft, review links, exports) and backend chaining details. **Deprecated** in favor of Scribe.
- `docs/05_creative_brief_prd.md` ‚Äî Creative Brief tool spec focusing on asset ingestion, AI tagging, storyboard editor, and storage constraints.
- `docs/scribe_lite/scribe_lite_prd.md` ‚Äî **Active** Scribe Lite PRD.
- `docs/scribe_lite/scribe_lite_schema_api.md` ‚Äî Canonical Schema & API Reference for Scribe Lite.
- `docs/archive/scribe_legacy/` ‚Äî Archived Scribe v1 documentation.
- `docs/07_team_central_prd.md` ‚Äî Team Central PRD for single-tenant internal team management, client tracking, and role-based access control. Replaces the Admin Settings PRD. Database migration: `20250122000001_team_central_tables.sql`.
- `docs/08_clickup_service_prd.md` ‚Äî ClickUp Service integration spec covering multi-tenant API credential management, task/space/user caching with TTL, and sync status tracking. Database migration: `20250122000003_clickup_service_tables.sql`.
- `docs/10_systems_overview.md` ‚Äî Running list of every service, its repo path, Render deployment, and shared dependencies. Update this table whenever new tools or env vars are introduced.

## Render Deployment Map
- **Services (Render Project: ‚ÄúEcomlabs Agency OS‚Äù)**
  - `frontend-web` ‚Äî Node/Next.js service deployed from `/frontend-web` (Render region: Virginia). Hosts the dashboard at `tools.ecomlabs.ca`.
  - `backend-core` ‚Äî Python FastAPI service deployed from `/backend-core` (Virginia). Provides APIs, agent orchestration, and communicates with Supabase.
  - `worker-sync` ‚Äî Python background worker deployed from `/worker-sync` (Virginia). Handles nightly syncs and long-running jobs.
  - *Note:* Screenshot shows recent deploys failed; verify build logs before the next release so we catch configuration drift early.
- **Env Group: `agency-os-env-var`**
  - Shared across the services above so every deployment receives consistent secrets.
  - Contains: `CLICKUP_API_TOKEN`, `GOOGLE_OAUTH_CLIENT_ID`, `GOOGLE_OAUTH_CLIENT_SECRET`, `MAX_UPLOAD_MB`, `NEXT_PUBLIC_BACKEND_URL`, `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `OPENAI_API_KEY`, `OPENAI_MODEL_PRIMARY`, `OPENAI_MODEL_FALLBACK`, `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, and `SUPABASE_JWT_SECRET`.
  - Keep Render as the source of truth; mirror critical values into local `.env.local` files as needed for development.

---
_Remember: keep this document short and actionable‚Äîlink to the PRDs for deep dives instead of duplicating their content._
